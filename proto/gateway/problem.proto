syntax = "proto3";

package problem.v1;

import "google/protobuf/empty.proto";


enum Language {
  LANGUAGE_UNSPECIFIED = 0;
  JAVASCRIPT = 1;
  PYTHON = 2;
  GO = 3;
}

enum Difficulty {
  DIFFICULTY_UNSPECIFIED = 0;
  EASY = 1;
  MEDIUM = 2;
  HARD = 3;
}

enum TestCaseCollectionType {
  TYPE_UNSPECIFIED = 0;
  RUN = 1;
  SUBMIT = 2;
}

// Sub messages for the problem message

message TestCase {
    string _id = 1;
    string input = 2;
    string output = 3;
}

message TestCaseCollection {
    repeated TestCase run = 1;
    repeated TestCase submit = 2;
}

message Example {
    string _id = 1;
    string input = 2;
    string output = 3;
    string explanation = 4;
}

message StarterCode {
  string _id = 1;        
  Language language = 2;
  string code = 3;
}

message TemplateCode {
    optional string _id = 1;
    Language language = 2;
    string submitWrapperCode = 3;
    string runWrapperCode = 4;
}


// main problem message for admin.

message Problem {
    string _id = 1;
    string questionId = 2;
    string title = 3;
    string description = 4;
    Difficulty difficulty = 5;
    repeated string tags = 6;
    repeated string constraints = 7;
    repeated StarterCode starterCodes = 8;
    TestCaseCollection testcaseCollection = 9;
    repeated Example examples = 10;
    bool active = 11;
    repeated TemplateCode templateCodes = 12;
    string createdAt = 13;
    string updatedAt = 14;
}

message ListProblemDetails {
    string _id = 1;
    string title = 2;
    string questionId = 3;
    Difficulty difficulty = 4;
    repeated string tags = 6;
    bool active = 11;
    string createdAt = 13;
    string updatedAt = 14;
}


// --- Service Definition --- 

service ProblemService {
    rpc CreateProblem(CreateProblemRequest) returns (Problem);
    rpc GetProblem(GetProblemRequest) returns (Problem);
    rpc GetProblemForPublic(GetProblemRequest) returns (GetProblemPublicResponse);
    rpc UpdateBasicProblemDetails(UpdateBasicProblemDetailsRequest) returns (google.protobuf.Empty);
    rpc ListProblems(ListProblemRequest) returns (ListProblemResponse);
    rpc AddTestCase(AddTestCaseRequest) returns (google.protobuf.Empty);
    rpc BulkUploadTestCases(BulkUploadTestCasesRequest) returns (google.protobuf.Empty);
    rpc RemoveTestCase(RemoveTestCaseRequest) returns (google.protobuf.Empty);
    rpc UpdateTemplateCode(UpdateTemplateCodeRequest) returns (google.protobuf.Empty);
    rpc CheckQuestionIdAvailability(CheckQuestionIdRequest) returns (google.protobuf.Empty);
    rpc CheckProblemTitle(CheckProblemTitleRequest) returns (google.protobuf.Empty);
}

message CreateProblemRequest {
    string questionId = 1;
    string title = 2;
    string description = 3;
    Difficulty difficulty = 4;
    repeated string tags = 5;
}

message GetProblemRequest {
    string _id = 1;
    optional string title = 2;
    optional string questionId = 3;
}

message GetProblemPublicResponse {
    string _id = 1;
    string questionId = 2;
    string title = 3;
    string description = 4;
    Difficulty difficulty = 5;
    repeated string tags = 6;
    repeated string constraints = 7;
    repeated StarterCode starterCodes = 8;
    repeated TestCase run = 9;
    repeated Example examples = 10;
    string createdAt = 13;
    string updatedAt = 14;
}

message ListProblemRequest {
    int32 page = 1;
    int32 limit = 2;

    // optional filters
    optional Difficulty difficulty = 3;
    repeated string tags = 4;
    optional bool active = 5;
    optional string search = 6;
    optional string questionId = 7;
    optional string sort = 8;
}

message ListProblemResponse {
    repeated ListProblemDetails problems = 1;
    int32 totalPage = 2;
    int32 currentPage = 3;
    int32 totalItems = 4;
}

message UpdateBasicProblemDetailsRequest {
    string _id = 1;
    optional string questionId = 2;
    optional string title = 3;
    optional string description = 4;
    optional Difficulty difficulty = 5;
    optional bool active = 6;
    repeated string tags = 7;
    repeated string constraints = 8;
    repeated Example examples = 9;
    repeated StarterCode starterCodes = 10;
}

message AddTestCaseRequest {
    string _id = 1;
    TestCaseCollectionType testCaseCollectionType = 2;
    TestCase testCase = 3;
}

message BulkUploadTestCasesRequest {
    string _id = 1;
    TestCaseCollectionType testCaseCollectionType = 2;
    repeated TestCase testCase = 3;
}


message RemoveTestCaseRequest {
    string _id = 1;
    string testCaseId = 2;
    TestCaseCollectionType testCaseCollectionType = 3;
}

message UpdateTemplateCode {
    optional Language language = 1;
    optional string submitWrapperCode = 2;
    optional string runWrapperCode = 3;
}

message UpdateTemplateCodeRequest{
    string _id = 1;
    string templateCodeId = 2;
    UpdateTemplateCode updatedTemplateCode = 3;
}

message CheckQuestionIdRequest {
    string questionId = 1;
}

message CheckProblemTitleRequest {
    string title = 2;
}

// === Submissions ==== 

message Stats {
    int32 totalTestCase = 1;
    int32 passedTestCase = 2;
    int32 failedTestCase = 3;
    double executionTimeMs = 4;
    double memoryMB = 5;
}

message FailedTestCase {
    int32 index = 1;
    string input = 2;
    string output = 3;
    string expectedOutput = 4;
}

message ExecutionResult {
    Stats stats = 1;
    optional FailedTestCase failedTestCase = 2;
}

message Submission {
    string _id = 1;
    string problemId = 2;
    string userId = 3;
    string username = 4;
    string country = 5;
    string title = 6;
    optional string battleId = 7;
    int32 score = 8;
    string status = 9;
    Language language = 10;
    string userCode = 11;
    optional ExecutionResult executionResult = 12;
    Difficulty difficulty = 13;
    bool isFirst = 14;
    string updatedAt = 15;
    string createdAt = 16;
}

// --- Service Definition ---

service SubmissionService {
    rpc CreateSubmission(CreateSubmissionRequest) returns (Submission);
    rpc UpdateSubmission(UpdateSubmissionRequest) returns (google.protobuf.Empty);
    rpc ListProblemSpecificSubmission(ListProblemSpecificSubmissionRequest) returns (ListProblemSpecificSubmissionResponse);
    rpc GetSubmissions(GetSubmissionsRequest) returns (GetSubmissionsResponse);
    rpc ListTopKGlobalLeaderboard(ListTopKGlobalLeaderboardRequest) returns (ListTopKGlobalLeaderboardResponse);
    rpc ListTopKCountryLeaderboard(ListTopKCountryLeaderboardRequest) returns (ListTopKCountryLeaderboardResponse);
    rpc GetDashboardStats(GetDashboardStatsRequest) returns (GetDashboardStatsResponse);
    rpc GetProblemSubmissionStats(google.protobuf.Empty) returns (GetProblemSubmissionStatsResponse);
    rpc UpdateCountryInLeaderboard(UpdateCountryRequest) returns (google.protobuf.Empty);
    rpc RemoveUserInLeaderboard(RemoveUserRequest) returns (google.protobuf.Empty);
}

message CreateSubmissionRequest {
    string problemId = 1;
    string userId = 2;
    string username = 3;
    optional string battleId = 4;
    optional string country = 5;
    string title = 6;
    Language language = 7;
    string userCode = 8;
    Difficulty difficulty = 9;
}

message UpdateSubmissionRequest {
    string _id = 1;
    string status = 3;
    ExecutionResult executionResult = 4;
}

message GetSubmissionsRequest {
    int32 page = 1;
    int32 limit = 2;

    optional string problemId = 3;
    optional string battleId = 4;
    optional string userId = 5; 
}

message GetSubmissionsResponse {
    repeated Submission submissions = 1;
    int32 totalPage = 2;
    int32 currentPage = 3;
    int32 totalItems = 4;
}

message ListProblemSpecificSubmissionRequest {
    string userId = 1;
    string problemId = 2;
    int32 limit = 3;
    optional string nextCursor = 4;
}

message ProblemSpecificSubmissions {
    string _id = 1;
    string status = 2;
    Language language = 3;
    ExecutionResult executionResult = 4;
    string userCode = 5;
    string createdAt = 6;
}

message ListProblemSpecificSubmissionResponse {
    repeated ProblemSpecificSubmissions submissions = 1;
    string nextCursor = 2;
    bool hasMore = 3;
}

message ListTopKGlobalLeaderboardRequest {
    int32 k = 1;
}
message LeaderboardUser {
    string id = 1;
    optional string entity = 2;
    int32 score = 3;
    string username = 4;
    optional int32 problemsSolved = 5;
    optional int32 rank = 6;
}

message ListTopKGlobalLeaderboardResponse {
    repeated LeaderboardUser users = 1;
}

message ListTopKCountryLeaderboardRequest {
    string country = 1;
    int32 k = 2;
}

message ListTopKCountryLeaderboardResponse {
    repeated LeaderboardUser users = 1;
}

message GetDashboardStatsRequest {
    string userId = 1;
    string userTimezone = 2;
}

message Activity {
    string date = 1;
    int32 count = 2;
}

message RecentActivity {
    string title = 1;
    string difficulty = 2;
    string status = 3;
    string timeAgo = 4;
}

message LeaderboardData {
    string userId = 1;
    string username = 2;
    int32 score = 3;
    string entity = 4;
    int32 globalRank = 5;
    int32 entityRank = 6;
}

message SolvedByDifficulty {
    string difficulty = 1;
    int32 count = 2;
}

message GetDashboardStatsResponse {
    repeated Activity heatmap = 1;
    int32 currentStreak = 2;
    LeaderboardData leaderboardDetails = 3;
    int32 problemsSolved = 4;
    repeated RecentActivity recentActivities = 5;
    repeated SolvedByDifficulty solvedByDifficulty = 6;
}

message UpdateCountryRequest {
    string userId = 1;
    string country = 2;
}

message RemoveUserRequest {
    string userId = 1;
}

message LanguageWiseSubmissionStats {
    string language = 1;
    int32 count = 2;
}

message SubmissionStats {
    int32 totalSubmissions = 1;
    int32 todaysSubmissions = 2;
    repeated LanguageWiseSubmissionStats languageWise = 3;
}

message DifficultyWiseProblemStats {
    string difficulty = 1;
    int32 count = 2;
}

message ProblemStats {
    int32 totalProblems = 1;
    int32 todaysProblems = 2;
    repeated DifficultyWiseProblemStats difficultyWise = 3;
}

message GetProblemSubmissionStatsResponse {
    SubmissionStats submissionStats = 1;
    ProblemStats problemStats = 2;
}